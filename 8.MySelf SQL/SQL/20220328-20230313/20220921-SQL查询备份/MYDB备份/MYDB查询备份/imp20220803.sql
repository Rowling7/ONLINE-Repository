--含断头路段的分组
--1、将所有数据明细插入临时表
IF OBJECT_ID('TEMPDB..#T1') IS NOT NULL DROP TABLE #T1
SELECT RTRIM(k1.A0102) A0102 ,RTRIM(k1.HA0102)HA0102,RTRIM(k1.K0101) K0101,RTRIM(k1.K0108) K0108,RTRIM(k1.K0109) K0109,k1.K0114,XH=0 
--,IDENTITY(INT, 0, 1) AS XUHAO 
INTO #T1
FROM K001 K1
WHERE k1.A0102 LIKE '42A%'
AND ISNULL(k1.K0123,'2') ='2' AND k1. K0124 IS NULL
AND LEFT(k1.K0101,1) IN ('G','S','Z')
ORDER BY k1.K0101,k1.K0108

SELECT * from #t1

DECLARE @M CHAR(20)
DECLARE @N INT
DECLARE @Q NUMERIC(8,3)

SET @M = 1
SET @N = 0
SET @Q = 1

UPDATE #T1 SET
@N = CASE WHEN RTRIM(@M) = RTRIM(K0101) AND @Q=K0108 THEN @N ELSE @N+1 END,
@M = RTRIM(K0101),
@Q = K0109,
XH = @N

SELECT *FROM #T1

IF OBJECT_ID('TEMPDB..#T2') IS NOT NULL DROP TABLE #T2

SELECT A0102,HA0102,K0101,MIN(K0108) K0108,MAX(K0109) K0109,SUM(K0114) K0114,XH -- ,sum(k6008)
into #T2
FROM #T1
GROUP BY A0102,HA0102,K0101,XH
ORDER BY K0101,K0108
SELECT*FROM #T2



IF OBJECT_ID('TEMPDB..#T3') IS NOT NULL DROP TABLE #T3
--收费站
SELECT	T.A0102,T.HA0102,T.K0101,T.K0108,T.K0109, T.K0114,T.XH,
		SUM(CASE WHEN K.K7801 IS NOT NULL THEN 1 ELSE 0 END ) K7801
FROM #T2 T
LEFT JOIN  K081 K 
	ON T.A0102 =K.A0102 
	AND T.K0101=CASE WHEN
		LEFT ( RTRIM(k.K0101) ,1) ='H'	THEN STUFF( RTRIM(K.K0101 )  ,1, 1, 'G')ELSE
		CASE WHEN 	LEFT (RTRIM(K.K0101 ) ,1) ='T'	THEN STUFF( RTRIM(K.K0101 ) , 1, 1, 'S')		
	ELSE  RTRIM(K.K0101 )   END END
	AND K.K7803 < = T.K0109 
	AND K.K7803 >=  T.K0108 
GROUP BY T.A0102,T.HA0102,T.K0101,T.K0108,T.K0109, T.K0114,T.XH
ORDER BY T.K0101,t.k0114



--服务区
SELECT	T.A0102,T.HA0102,T.K0101,T.K0108,T.K0109, T.K0114,T.XH,
		SUM(CASE WHEN K.K7501 IS NOT NULL THEN 1 ELSE 0 END ) K7501
FROM #T2 T
LEFT JOIN K078 K
	 ON T.A0102 =K.A0102 
	AND T.K0101=CASE WHEN
		LEFT ( RTRIM(k.K0101) ,1) ='H'	THEN STUFF( RTRIM(K.K0101 )  ,1, 1, 'G')ELSE
		CASE WHEN 	LEFT (RTRIM(K.K0101 ) ,1) ='T'	THEN STUFF( RTRIM(K.K0101 ) , 1, 1, 'S')		
	ELSE  RTRIM(K.K0101 )   END END
	AND K.K7001 < = T.K0109 
	AND K.K7001 >=  T.K0108 
GROUP BY T.A0102,T.HA0102,T.K0101,T.K0108,T.K0109, T.K0114,T.XH
ORDER BY T.K0101,t.k0114


--桥梁
SELECT	T.A0102,T.HA0102,T.K0101,T.K0108,T.K0109, T.K0114,T.XH,
		SUM(CASE WHEN K.K6001 IS NOT NULL THEN 1 ELSE 0 END ) K6001,
		SUM(K.K6008  ) K6008
FROM #T2 T
LEFT JOIN K060 K
	 ON T.A0102 =K.A0102 
	AND T.K0101=CASE WHEN
		LEFT ( RTRIM(k.K0101) ,1) ='H'	THEN STUFF( RTRIM(K.K0101 )  ,1, 1, 'G')ELSE
		CASE WHEN 	LEFT (RTRIM(K.K0101 ) ,1) ='T'	THEN STUFF( RTRIM(K.K0101 ) , 1, 1, 'S')		
	ELSE  RTRIM(K.K0101 )   END END
	AND K.K6003 < = T.K0109 
	AND K.K6003 >=  T.K0108 
GROUP BY T.A0102,T.HA0102,T.K0101,T.K0108,T.K0109, T.K0114,T.XH
ORDER BY T.K0101,t.k0114



--隧道
SELECT	T.A0102,T.HA0102,T.K0101,T.K0108,T.K0109, T.K0114,T.XH,
		SUM(CASE WHEN K.K6301 IS NOT NULL THEN 1 ELSE 0 END ) K6301,
		SUM(K.K6305  ) K6305
FROM #T2 T
LEFT JOIN K063 K
	 ON T.A0102 =K.A0102 
	AND T.K0101=CASE WHEN
		LEFT ( RTRIM(k.K0101) ,1) ='H'	THEN STUFF( RTRIM(K.K0101 )  ,1, 1, 'G')ELSE
		CASE WHEN 	LEFT (RTRIM(K.K0101 ) ,1) ='T'	THEN STUFF( RTRIM(K.K0101 ) , 1, 1, 'S')		
	ELSE  RTRIM(K.K0101 )   END END
	AND K.K6324 < = T.K0109 
	AND K.K6324 >=  T.K0108 
GROUP BY T.A0102,T.HA0102,T.K0101,T.K0108,T.K0109, T.K0114,T.XH
ORDER BY T.K0101,t.k0114
