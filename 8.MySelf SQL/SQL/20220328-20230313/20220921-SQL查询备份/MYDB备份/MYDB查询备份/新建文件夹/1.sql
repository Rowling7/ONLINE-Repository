
IF OBJECT_ID('TEMPDB..#T1') IS NOT NULL DROP TABLE #T1

SELECT 
--	ROW_NUMBER () OVER (ORDER BY RTRIM(K1.K0108) ASC) ROWNUM
	RTRIM(K1. A0102 ) A0102 --管理单位代码
	,RTRIM(K1.HA0102 ) HA0102 --管理单位
	,CASE WHEN LEN( RTRIM(K1.K0101 ) ) > 9 THEN LEFT ( RTRIM(K1.K0101 ), 4 ) ELSE RTRIM(K1.K0101 )  END  K0101 --路线编号
	,RTRIM(K1.K0108) K0108 --起点桩号
	,RTRIM(K1.K0109) K0109 --止点桩号
	--,MAX(K1.K0115) MK0115
	,rtrim(K1.K0115) K0115
--	,CASE WHEN K1.K0123='1'OR K1.K0192 ='6' THEN 999
--	ELSE CASE WHEN  ISNULL(K1.K0123,'2')='2' AND K1.K0192 <>'6' THEN K1.K0115 END END  K0115
	,SUM(CASE WHEN K1.K0304='10'  THEN ISNULL(K1.K0114,0) END)	ZLC 
INTO #T1
FROM
	K001 K1

WHERE
	LEFT ( K1.K0101, 1 ) IN ( 'G', 'S', 'Z' ) AND 
	K1.K0304='10' AND --高速
	--K1.K0192 <>'6' AND  --断链类型不是断头路
	--ISNULL(K1.K0123,'2')='2' AND  --断头路
	ISNULL(K1.K0124,'')='' AND --重复路线
	--K1.A0102 ='42A72' AND 
	--K1.K0101 ='G59' AND
	--K1.A0102 ='42A53' AND 
	--K1.K0101 ='G6911' AND
	1=1
GROUP BY
	RTRIM(K1.A0102 )
	,RTRIM(K1.HA0102 )
	,K1.K0115
	,K1.K0123
	 ,K1.K0192
	,CASE WHEN LEN( RTRIM( K1.K0101 ) ) > 9 THEN LEFT ( RTRIM(K1.K0101 ), 4 ) ELSE RTRIM(K1.K0101 )  END
	,RTRIM(K1.K0109)
	,RTRIM(K1.K0108)
ORDER BY
	RTRIM(K1.K0108) 
	ASC
	
--SELECT *FROM #T1

/*
SELECT 
	T.A0102
	,T.HA0102
	,T.K0101
	,T.K0108
	,T.K0109
	,T.K0115
	,T.ZLC
	,T.ROWNUM AS TR
	,M.ROWNUM AS MR
	,SUM(M.ZLC) AS MZLC
	--,LEN(RTRIM(T.K0109))
	--,LEFT(T.K0109,LEN(RTRIM(T.K0109))) tk0109
	--,LEFT(T.K0108,LEN(RTRIM(T.K0108))) tk0108
	--,CASE WHEN cast(LEFT(T.K0108,LEN(RTRIM(T.K0108))) AS NUMERIC(10,0))  = CAST(LEFT(T.K0109,LEN(RTRIM(T.K0109)))  AS NUMERIC (10,0))THEN SUM(M.ZLC) ELSE ''END  
	--,CASE WHEN LEFT(T.K0108,LEN(RTRIM(T.K0108)))  = LEFT(T.K0109,LEN(RTRIM(T.K0109)))THEN '' ELSE SUM(M.ZLC) END  
FROM 
	#T1 T
LEFT JOIN
	#T1 M  ON  LEFT(M.K0108,LEN(RTRIM(M.K0108)))  = LEFT(T.K0109,LEN(RTRIM(T.K0109)))

GROUP BY 
		T.A0102
	,T.HA0102
	,T.K0101
	,T.K0108
	,T.K0109
	,T.K0115
	,T.ZLC
	,M.ROWNUM
	,T.ROWNUM
	,M.K0108
	
*/	




SELECT 
	T.A0102
	,T.HA0102
	,T.K0101
	,T.K0108
	,T.K0109
	,T.K0115 
	,M.K0115 
	,T.ZLC AS TZ 
	,M.ZLC AS MZ 
	,SUM(T.ZLC) TZLC
			
FROM 
	#T1 T
LEFT JOIN
	#T1 M  ON  LEFT(M.K0115,LEN(RTRIM(M.K0115)))  = LEFT(T.K0115,LEN(RTRIM(T.K0115))) +1
	
--WHERE M.ZLC IS NOT NULL 

GROUP BY 
	T.A0102
	,T.HA0102
	,T.K0101
	,T.K0108
	,T.K0109
	,T.K0115
	,T.ZLC
	,M.ZLC
	,T.K0115 
	,M.K0115 
	,M.K0108
	
--HAVING GROUPING(T.K0115)= GROUPING(M.K0115)
--HAVING  T.K0115 = T.K0115	
	
SELECT * FROM #T1