--隧道  对
SELECT 
	RTRIM(B.A0102) A0102,
	RTRIM(B.HA0102) HA0102,
	B.K0101,
	SUM(CASE WHEN A.K6304 IN ('1','2','3','4') THEN 1 ELSE 0 END) 总隧道数,
	SUM(CASE WHEN A.K6304 IN ('1','2','3','4') THEN A.K6305 ELSE 0 END) 总隧道延米数
FROM K063 A
	RIGHT JOIN (
		SELECT RTRIM(HA0102) HA0102,RTRIM(A0102) A0102,K0101
		FROM ##T1 T
		GROUP BY HA0102,RTRIM(A0102),K0101
		)B  ON A.HA0102 = B.HA0102 
		OR	B.K0101= 
CASE WHEN
		LEFT (( CASE WHEN LEN( RTRIM(A.K0101 ) ) > 5 THEN LEFT ( RTRIM(A.K0101 ), 3 ) ELSE RTRIM(A.K0101 )  END),1) ='H'
	THEN 
		STUFF(( CASE WHEN LEN( RTRIM(A.K0101 ) ) > 5 THEN LEFT ( RTRIM(A.K0101 ), 3 ) ELSE RTRIM(A.K0101 )  END), 1, 1, 'G')
	ELSE
		CASE WHEN 	LEFT (( CASE WHEN LEN( RTRIM(A.K0101 ) ) > 5 THEN LEFT ( RTRIM(A.K0101 ), 3 ) ELSE RTRIM(A.K0101 )  END),1) ='T'
		THEN 
			STUFF(( CASE WHEN LEN( RTRIM(A.K0101 ) ) > 5 THEN LEFT ( RTRIM(A.K0101 ), 3 ) ELSE RTRIM(A.K0101 )  END), 1, 1, 'S')		
	ELSE 
		 CASE WHEN LEN( RTRIM(A.K0101 ) ) > 5 THEN LEFT ( RTRIM(A.K0101 ), 3 ) ELSE RTRIM(A.K0101 )  
		 END END END 
				
		
WHERE B.A0102 IS NOT NULL --AND  B.K0101='G0421'
GROUP BY B.K0101,RTRIM(B.HA0102),RTRIM(B.A0102)-- WITH ROLLUP
HAVING GROUPING(RTRIM(B.A0102))=GROUPING(RTRIM(B.HA0102))
--ORDER BY RTRIM(B.HA0102)