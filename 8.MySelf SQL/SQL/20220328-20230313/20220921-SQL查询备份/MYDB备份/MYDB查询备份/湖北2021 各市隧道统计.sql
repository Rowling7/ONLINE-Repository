 --USE [HRP-DBMS2021湖北]
IF OBJECT_ID('TEMPDB..#T1') IS NOT NULL DROP TABLE #T1

SELECT
(CASE WHEN LEN(K.A0102)='6'AND LEFT(K.A0102,4)<4290 THEN LEFT (K.A0102,4) ELSE
	CASE WHEN LEN(K.A0102)='5' THEN LEFT(K.A0102, 3) ELSE
		K.A0102 END END) AS A0102,
D.OBJNAME ,RTRIM(D.OBJJC) OBJJC,
sum(1)  AS ZJ,
sum(K6305) AS  YM,
sum(case when K6304='1' then 1 else 0 end)	AS	TCSD,--	特长隧道,
sum(case when K6304='1' then K6305 else 0 end)	AS	TCYM,--	特长隧道延米,
sum(case when K6304='2' then 1 else 0 end)	AS	CSD,--	长隧道,
sum(case when K6304='2' then K6305 else 0 end)	AS	CYM,--	长隧道延米,
sum(case when K6304='3' then 1 else 0 end)	AS	ZSD,--	中隧道,
sum(case when K6304='3' then K6305 else 0 end)	AS	ZYM,--	中隧道延米,
sum(case when K6304='4' then 1 else 0 end)	AS	DSD,--	短隧道,
sum(case when K6304='4' then K6305 else 0 end)	AS	DYM--	短隧道延米
INTO #T1 
FROM  K063 K
RIGHT JOIN DA0102 D  ON   D.OBJNAME = (CASE WHEN LEN(K.A0102)='6'AND LEFT(K.A0102,4)<4290 THEN LEFT (K.A0102,4) ELSE
	CASE WHEN LEN(K.A0102)='5' THEN LEFT(K.A0102, 3) ELSE
		K.A0102 END END)

WHERE-- ISNULL(K0124,'')='' AND ISNULL(K0123,'2')='2' AND A0102 LIKE '42%' AND D.PARENTID ='1' AND

left(k0101,1) in ('G','H','S','T','X','Y','Z','C')
 --K0101 LIKE 'S%'
--AND ISNULL(V0301,'2')='2'
GROUP BY ((CASE WHEN LEN(K.A0102)='6'AND LEFT(K.A0102,4)<4290 THEN LEFT (K.A0102,4) ELSE
	CASE WHEN LEN(K.A0102)='5' THEN LEFT(K.A0102, 3) ELSE
		K.A0102 END END)),D.OBJNAME ,D.OBJJC 
	WITH ROLLUP
HAVING GROUPING((CASE WHEN LEN(K.A0102)='6'AND LEFT(K.A0102,4)<4290 THEN LEFT (K.A0102,4) ELSE
	CASE WHEN LEN(K.A0102)='5' THEN LEFT(K.A0102, 3) ELSE
		K.A0102 END END))= GROUPING(D.OBJJC )
ORDER BY K.A0102

SELECT * FROM #t1
--包含空值
SELECT D.OBJNAME AS 行政代码,D.OBJJC AS  行政名称,A.ZJ 总计 ,A.YM 延米,A.TCSD 特长隧道,A.TCYM 特长隧道延米,A.CSD 长隧道,A.CYM 长隧道延米,A.ZSD 中隧道,A.ZYM 中隧道延米,A.DSD 短隧道,A.DYM 短隧道延米
FROM #T1 A
RIGHT JOIN DA0102 D ON D.OBJNAME= A.A0102  
WHERE D.PARENTID ='1'
ORDER BY D.OBJNAME